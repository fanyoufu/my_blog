<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>003: 描述一下 V8 执行一段JS代码的过程？ | 神三元的博客</title>
    <meta name="description" content="跟着前端万粉博主，一起构建完整知识体系">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/my_blog/assets/css/0.styles.45a5eb1d.css" as="style"><link rel="preload" href="/my_blog/assets/js/app.948b63c2.js" as="script"><link rel="preload" href="/my_blog/assets/js/70.7b433f7b.js" as="script"><link rel="prefetch" href="/my_blog/assets/js/10.d85e12a5.js"><link rel="prefetch" href="/my_blog/assets/js/11.b3b936ea.js"><link rel="prefetch" href="/my_blog/assets/js/12.6643b689.js"><link rel="prefetch" href="/my_blog/assets/js/13.8326ad7a.js"><link rel="prefetch" href="/my_blog/assets/js/14.2582a0b5.js"><link rel="prefetch" href="/my_blog/assets/js/15.b94a101c.js"><link rel="prefetch" href="/my_blog/assets/js/16.dbe46776.js"><link rel="prefetch" href="/my_blog/assets/js/17.39f482a7.js"><link rel="prefetch" href="/my_blog/assets/js/18.4c9d8b85.js"><link rel="prefetch" href="/my_blog/assets/js/19.4d50da91.js"><link rel="prefetch" href="/my_blog/assets/js/2.8451919b.js"><link rel="prefetch" href="/my_blog/assets/js/20.0cad77b9.js"><link rel="prefetch" href="/my_blog/assets/js/21.8c219ca3.js"><link rel="prefetch" href="/my_blog/assets/js/22.5f5e8b05.js"><link rel="prefetch" href="/my_blog/assets/js/23.b2ae0b70.js"><link rel="prefetch" href="/my_blog/assets/js/24.33e8bef2.js"><link rel="prefetch" href="/my_blog/assets/js/25.0e56eca0.js"><link rel="prefetch" href="/my_blog/assets/js/26.3184338f.js"><link rel="prefetch" href="/my_blog/assets/js/27.b4abe910.js"><link rel="prefetch" href="/my_blog/assets/js/28.8470ba48.js"><link rel="prefetch" href="/my_blog/assets/js/29.e230d459.js"><link rel="prefetch" href="/my_blog/assets/js/3.c8d75435.js"><link rel="prefetch" href="/my_blog/assets/js/30.5cbb0fa3.js"><link rel="prefetch" href="/my_blog/assets/js/31.4b683acf.js"><link rel="prefetch" href="/my_blog/assets/js/32.bcce3e54.js"><link rel="prefetch" href="/my_blog/assets/js/33.68bf9cdf.js"><link rel="prefetch" href="/my_blog/assets/js/34.529a8876.js"><link rel="prefetch" href="/my_blog/assets/js/35.6ce88514.js"><link rel="prefetch" href="/my_blog/assets/js/36.909a9ec7.js"><link rel="prefetch" href="/my_blog/assets/js/37.f39729e6.js"><link rel="prefetch" href="/my_blog/assets/js/38.a9b52dea.js"><link rel="prefetch" href="/my_blog/assets/js/39.94f943f4.js"><link rel="prefetch" href="/my_blog/assets/js/4.c2c76e6c.js"><link rel="prefetch" href="/my_blog/assets/js/40.352b7630.js"><link rel="prefetch" href="/my_blog/assets/js/41.bcd6e17d.js"><link rel="prefetch" href="/my_blog/assets/js/42.37eef5f1.js"><link rel="prefetch" href="/my_blog/assets/js/43.cd98cdeb.js"><link rel="prefetch" href="/my_blog/assets/js/44.6e0ed468.js"><link rel="prefetch" href="/my_blog/assets/js/45.040b712f.js"><link rel="prefetch" href="/my_blog/assets/js/46.64dd1d9c.js"><link rel="prefetch" href="/my_blog/assets/js/47.fff8c571.js"><link rel="prefetch" href="/my_blog/assets/js/48.9af6e57a.js"><link rel="prefetch" href="/my_blog/assets/js/49.f499f49c.js"><link rel="prefetch" href="/my_blog/assets/js/5.d2e3e3d0.js"><link rel="prefetch" href="/my_blog/assets/js/50.ce64b6d1.js"><link rel="prefetch" href="/my_blog/assets/js/51.fd6252ec.js"><link rel="prefetch" href="/my_blog/assets/js/52.286b515a.js"><link rel="prefetch" href="/my_blog/assets/js/53.23182e78.js"><link rel="prefetch" href="/my_blog/assets/js/54.8d1bf286.js"><link rel="prefetch" href="/my_blog/assets/js/55.9c66bd7f.js"><link rel="prefetch" href="/my_blog/assets/js/56.b7146825.js"><link rel="prefetch" href="/my_blog/assets/js/57.6675fa47.js"><link rel="prefetch" href="/my_blog/assets/js/58.4b78e999.js"><link rel="prefetch" href="/my_blog/assets/js/59.0f01e260.js"><link rel="prefetch" href="/my_blog/assets/js/6.78ebfd6d.js"><link rel="prefetch" href="/my_blog/assets/js/60.59285bc0.js"><link rel="prefetch" href="/my_blog/assets/js/61.5d37b139.js"><link rel="prefetch" href="/my_blog/assets/js/62.58b3cc6c.js"><link rel="prefetch" href="/my_blog/assets/js/63.577b6738.js"><link rel="prefetch" href="/my_blog/assets/js/64.1dbcf2a5.js"><link rel="prefetch" href="/my_blog/assets/js/65.606143dc.js"><link rel="prefetch" href="/my_blog/assets/js/66.61392498.js"><link rel="prefetch" href="/my_blog/assets/js/67.b9e4854e.js"><link rel="prefetch" href="/my_blog/assets/js/68.71ac5385.js"><link rel="prefetch" href="/my_blog/assets/js/69.00112b06.js"><link rel="prefetch" href="/my_blog/assets/js/7.68fa5c4e.js"><link rel="prefetch" href="/my_blog/assets/js/71.6864d6d8.js"><link rel="prefetch" href="/my_blog/assets/js/72.2ec3b7b1.js"><link rel="prefetch" href="/my_blog/assets/js/73.5c212c7c.js"><link rel="prefetch" href="/my_blog/assets/js/74.8c6609db.js"><link rel="prefetch" href="/my_blog/assets/js/75.df2bf68a.js"><link rel="prefetch" href="/my_blog/assets/js/76.bc4863fd.js"><link rel="prefetch" href="/my_blog/assets/js/77.de02e2f3.js"><link rel="prefetch" href="/my_blog/assets/js/78.0a03b0b8.js"><link rel="prefetch" href="/my_blog/assets/js/79.710ff1ec.js"><link rel="prefetch" href="/my_blog/assets/js/8.3b2ea4e3.js"><link rel="prefetch" href="/my_blog/assets/js/9.d42609f7.js">
    <link rel="stylesheet" href="/my_blog/assets/css/0.styles.45a5eb1d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my_blog/" class="home-link router-link-active"><!----> <span class="site-name">神三元的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/sanyuan0704/frontend_daily_question" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/sanyuan0704/frontend_daily_question" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <a target="_blank" href="https://juejin.im/book/5da96626e51d4524ba0fd237" class="img_wrapper"><img src="/my_blog/gg.jpg" width="200px" height="150px" alt style="margin：auto; margin-top: 10px"></a> <ul class="sidebar-links"><li><a href="/my_blog/nav/" class="sidebar-link">文章目录</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS-基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS-深入数组</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS-其它API原理</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>JS-V8引擎原理</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/my_blog/js-v8/001.html" class="sidebar-link">01: JavaScript内存机制之问——数据是如何存储的？</a></li><li><a href="/my_blog/js-v8/002.html" class="sidebar-link">002：V8 引擎如何进行垃圾内存的回收？</a></li><li><a href="/my_blog/js-v8/003.html" class="active sidebar-link">003: 描述一下 V8 执行一段JS代码的过程？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my_blog/js-v8/003.html#_1-生成-ast" class="sidebar-link">1.生成 AST</a></li><li class="sidebar-sub-header"><a href="/my_blog/js-v8/003.html#_2-生成字节码" class="sidebar-link">2. 生成字节码</a></li><li class="sidebar-sub-header"><a href="/my_blog/js-v8/003.html#_3-执行代码" class="sidebar-link">3. 执行代码</a></li></ul></li><li><a href="/my_blog/js-v8/004.html" class="sidebar-link">004：如何理解EventLoop——宏任务和微任务篇</a></li><li><a href="/my_blog/js-v8/005.html" class="sidebar-link">005: 如何理解EventLoop——浏览器篇</a></li><li><a href="/my_blog/js-v8/006.html" class="sidebar-link">006: 如何理解EventLoop——nodejs篇</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS-异步I/O及异步编程</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Chromium-架构篇</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Chromium-渲染篇</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Chromium-事件处理</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Chromium-网络</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Chromium-安全</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端性能相关</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>扩展阅读</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_003-描述一下-v8-执行一段js代码的过程？"><a href="#_003-描述一下-v8-执行一段js代码的过程？" aria-hidden="true" class="header-anchor">#</a> 003: 描述一下 V8 执行一段JS代码的过程？</h1> <p>前端相对来说是一个比较新兴的领域，因此各种前端框架和工具层出不穷，让人眼花缭乱，尤其是各大厂商推出<code>小程序</code>之后<code>各自制定标准</code>，让前端开发的工作更加繁琐，在此背景下为了抹平平台之间的差异，诞生的各种<code>编译工具/框架</code>也数不胜数。但无论如何，想要赶上这些框架和工具的更新速度是非常难的，即使赶上了也很难产生自己的<code>技术积淀</code>，一个更好的方式便是学习那些<code>本质的知识</code>，抓住上层应用中不变的<code>底层机制</code>，这样我们便能轻松理解上层的框架而不仅仅是被动地使用，甚至能够在适当的场景下自己造出轮子，以满足开发效率的需求。</p> <p>站在 V8 的角度，理解其中的执行机制，也能够帮助我们理解很多的上层应用，包括Babel、Eslint、前端框架的底层机制。那么，一段 JavaScript 代码放在 V8 当中究竟是如何执行的呢？</p> <p>首先需要明白的是，机器是读不懂 JS 代码，机器只能理解特定的机器码，那如果要让 JS 的逻辑在机器上运行起来，就必须将 JS 的代码翻译成机器码，然后让机器识别。JS属于解释型语言，对于解释型的语言说，解释器会对源代码做如下分析:</p> <ul><li>通过词法分析和语法分析生成 AST(抽象语法树)</li> <li>生成字节码</li></ul> <p>然后解释器根据字节码来执行程序。但 JS 整个执行的过程其实会比这个更加复杂，接下来就来一一地拆解。</p> <h2 id="_1-生成-ast"><a href="#_1-生成-ast" aria-hidden="true" class="header-anchor">#</a> 1.生成 AST</h2> <p>生成 AST 分为两步——词法分析和语法分析。</p> <p>词法分析即分词，它的工作就是将一行行的代码分解成一个个token。 比如下面一行代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'sanyuan'</span>
</code></pre></div><p>其中会把句子分解成四个部分:</p> <p><img src="/my_blog/week07/7.jpg" alt="project"></p> <p>即解析成了四个token，这就是词法分析的作用。</p> <p>接下来语法分析阶段，将生成的这些 token 数据，根据一定的语法规则转化为AST。举个例子:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'sanyuan'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre></div><p>最后生成的 AST 是这样的:</p> <p><img src="/my_blog/week07/8.jpg" alt="project"></p> <p>当生成了 AST 之后，编译器/解释器后续的工作都要依靠 AST 而不是源代码。顺便补充一句，babel 的工作原理就是将ES5 的代码解析生成<code>ES5的AST</code>，然后将ES5 的 AST 转换为 <code>ES6 的AST</code>,最后才将 ES6 的 AST 转化为具体的 ES6 代码。由于本文着重阐述原理，关于 babel 编译的细节就不展开了，推荐大家去读一读荒山的<a href="https://juejin.im/post/5d94bfbf5188256db95589be" target="_blank" rel="noopener noreferrer">babel文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 帮你打开新世界的大门: )</p> <p>回到 V8 本身，生成 AST 后，接下来会生成执行上下文，关于执行上下文，可以参考上上篇《JavaScript内存机制之问——数据是如何存储的？》中对于上下文压栈出栈过程的讲解。</p> <h2 id="_2-生成字节码"><a href="#_2-生成字节码" aria-hidden="true" class="header-anchor">#</a> 2. 生成字节码</h2> <p>开头就已经提到过了，生成 AST 之后，直接通过 V8 的解释器(也叫Ignition)来生成字节码。但是<code>字节码</code>并不能让机器直接运行，那你可能就会说了，不能执行还转成字节码干嘛，直接把 AST 转换成机器码不就得了，让机器直接执行。确实，在 V8 的早期是这么做的，但后来因为机器码的体积太大，引发了严重的内存占用问题。</p> <p>给一张对比图让大家直观地感受以下三者代码量的差异:</p> <p><img src="/my_blog/week07/9.jpg" alt="project"></p> <p>很容易得出，字节码是比机器码轻量得多的代码。那 V8 为什么要使用字节码，字节码到底是个什么东西？</p> <blockquote><p>子节码是介于AST 和 机器码之间的一种代码，但是与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码然后执行。</p></blockquote> <p>字节码仍然需要转换为机器码，但和原来不同的是，现在不用一次性将全部的字节码都转换成机器码，而是通过解释器来逐行执行字节码，省去了生成二进制文件的操作，这样就大大降低了内存的压力。</p> <h2 id="_3-执行代码"><a href="#_3-执行代码" aria-hidden="true" class="header-anchor">#</a> 3. 执行代码</h2> <p>接下来，就进入到字节码解释执行的阶段啦！</p> <p>在执行字节码的过程中，如果发现某一部分代码重复出现，那么 V8 将它记做<code>热点代码</code>(HotSpot)，然后将这么代码编译成<code>机器码</code>保存起来，这个用来编译的工具就是V8的<code>编译器</code>(也叫做<code>TurboFan</code>)
, 因此在这样的机制下，代码执行的时间越久，那么执行效率会越来越高，因为有越来越多的字节码被标记为<code>热点代码</code>，遇到它们时直接执行相应的机器码，不用再次将转换为机器码。</p> <p>其实当你听到有人说 JS 就是一门解释器语言的时候，其实这个说法是有问题的。因为字节码不仅配合了解释器，而且还和编译器打交道，所以 JS 并不是完全的解释型语言。而编译器和解释器的
根本区别在于前者会编译生成二进制文件但后者不会。</p> <p>并且，这种字节码跟编译器和解释器结合的技术，我们称之为<code>即时编译</code>, 也就是我们经常听到的<code>JIT</code>。</p> <p>这就是 V8 中执行一段JS代码的整个过程，梳理一下:</p> <ol><li>首先通过词法分析和语法分析生成 <code>AST</code></li> <li>将 AST 转换为字节码</li> <li>由解释器逐行执行字节码，遇到热点代码启动编译器进行编译，生成对应的机器码, 以优化执行效率</li></ol> <p>关于这个问题的拆解就到这里，希望对你有所启发。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/my_blog/js-v8/002.html" class="prev">
          002：V8 引擎如何进行垃圾内存的回收？
        </a></span> <span class="next"><a href="/my_blog/js-v8/004.html">
          004：如何理解EventLoop——宏任务和微任务篇
        </a>
        →
      </span></p></div>  <div class="qrcode"><img src="/my_blog/qrcode.png" alt> <p>微信公众号: <span>前端三元同学</span></p> <p>获取更多资料/联系加交流群</p></div></div> <!----></div></div>
    <script src="/my_blog/assets/js/app.948b63c2.js" defer></script><script src="/my_blog/assets/js/70.7b433f7b.js" defer></script>
  </body>
</html>
